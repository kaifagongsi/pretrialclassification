<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kfgs.pretrialclassification.dao.FenleiBaohuMainMapper">

    <sql id="Base_Column_List">
        ID,MINGCHENG,TYPE,SQR,SQH,PDF_PATH,STATE,SIMPLECLASSCODE,CHUANTIME,JINANTIME,MESSAGE,ORAGINIZATION
    </sql>

    <select id="findAll" resultType="com.kfgs.pretrialclassification.domain.FenleiBaohuMain">
        select  <include refid="Base_Column_List"/> from  fenlei_baohu_main
    </select>

    <select id="findMainByState" resultType="com.kfgs.pretrialclassification.domain.FenleiBaohuMain">
        select m.id,
               mingcheng,
               m.simpleclasscode,
               (to_date(jinantime,'yyyymmddhh24miss') - to_date('1970-01-01 08:00:00','yyyy-mm-dd hh24:mi:ss'))*86400000 as jinantime,
               r.worker as worker,
               (select u.areaname
                  from fenlei_baohu_userinfo u
                 where u.workername = r.worker) as areaname,
               m.type
          from fenlei_baohu_main m,
               (select * from fenlei_baohu_result where classtype = '主') r
         where m.state = #{state}
           and r.id = m.id

    </select>

    <select id="selectCaseIn" resultType="com.kfgs.pretrialclassification.domain.ext.FenleiBaohuMainExt" >
       select oraginization,
           count(1) as totalCount,
           sum(decode(type,'FM',1,'XX',0)) as fmCount,
           sum(decode(type,'FM',0,'XX',1)) as xxCount,
           sum(decode(state,'0',1,0)) as wfpCount,
           sum(decode(state,'1',1,0)) as wccCount,
           sum(decode(state,'2',1,0)) as ywcCount,
           sum(decode(state,'7',1,0)) as cjCount
      from FENLEI_BAOHU_MAIN
        <if test="begintime!=''and endtime!=''">
            where jinantime between #{begintime} and #{endtime}
        </if>
      group by oraginization
    </select>

    <select id="selectByCondition" resultType="com.kfgs.pretrialclassification.domain.ext.FenleiBaohuMainResultExt">
        select m.id,m.mingcheng,m.type,m.sqr,m.sqh,m.pdf_path,m.state,m.simpleclasscode,m.message,m.oraginization,
        (to_date(jinantime,'yyyymmddhh24miss') - to_date('1970-01-01 08:00:00','yyyy-mm-dd hh24:mi:ss'))*86400000 as jinantime,
        (to_date(chuantime,'yyyymmddhh24miss') - to_date('1970-01-01 08:00:00','yyyy-mm-dd hh24:mi:ss'))*86400000 as chuantime,
        t_mr.maintype,t_mr.mainworker,t_mr.asstype,t_mr.assworker,t_mr.ipci
        from FENLEI_BAOHU_MAIN m
        left join
        (select t2.id,t2.maintype,t2.mainworker,t2.ipci,t1.asstype,t1.assworker from
        (select r.id,r.worker as mainworker,r.classtype as maintype,r.ipci from FENLEI_BAOHU_RESULT r where r.classtype='主')t2
        left join
        (select r.id,wm_concat(distinct r.classtype) as asstype,wm_concat(r.worker) as assworker from FENLEI_BAOHU_RESULT r where r.classtype='副' group by r.id)t1
        on t2.id=t1.id)t_mr on m.id=t_mr.id where 1=1
        <if test="id!=''">
            AND m.id = #{id}
        </if>
        <if test="name!=''">
            AND m.mingcheng = #{name}
        </if>
        <if test="sqr!=''">
            AND m.sqr = #{sqr}
        </if>
        <if test="sqh!=''">
            AND m.id = #{sqh}
        </if>
        <if test="worker!=''">
            AND t_mr.mainworker like concat('%',#{worker}) or t_mr.assworker like concat(concat('%',#{worker}),'%')
        </if>
        <if test="state!=''">
            AND m.state = #{state}
        </if>
        <if test="begintime!=''and endtime!=''">
            AND m.chuantime between #{begintime} and #{endtime}
        </if>

    </select>


</mapper>
